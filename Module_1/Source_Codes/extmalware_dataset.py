from subprocess import Popen as out
import subprocess
import re
import os,shutil
cmd="py androaxml.py -i "
os.chdir("malware")
cwd=os.getcwd()
print(cwd)
files=os.listdir()
ds=open("dataset.csv","w")
mal_perm=["INTERNET","READ_PHONE_STATE","ACCESS_NETWORK_STATE","WRITE_EXTERNAL_STORAGE","READ_SMS","ACCESS_WIFI_STATE","RECEIVE_BOOT_COMPLETED","WRITE_SMS","SEND_SMS","RECEIVE_SMS","VIBRATE","ACCESS_COARSE_LOCATION","READ_CONTACTS","CALL_PHONE","ACCESS_FINE_LOCATION","WAKE_LOCK","WRITE_CONTACTS","CHANGE_WIFI_STATE","WRITE_APN_SETTINGS","RESTART_PACKAGES"]
ds.write("NAME,INTERNET,READ_PHONE_STATE,ACCESS_NETWORK_STATE,WRITE_EXTERNAL_STORAGE,READ_SMS,ACCESS_WIFI_STATE,RECEIVE_BOOT_COMPLETED,WRITE_SMS,SEND_SMS,RECEIVE_SMS,VIBRATE,ACCESS_COARSE_LOCATION,READ_CONTACTS,CALL_PHONE,ACCESS_FINE_LOCATION,WAKE_LOCK,WRITE_CONTACTS,CHANGE_WIFI_STATE,WRITE_APN_SETTINGS,RESTART_PACKAGES\n")
for j in range(len(files)):
    ext=os.path.splitext(files[j])[1]
    if(ext==".apk"):
        print(files[j])
        a=out(cmd+files[j],stdout=subprocess.PIPE)
        a,err=a.communicate()
        with open(str(files[j]).replace(".apk","")+".xml","wb") as f:
            f.write(a)
        bit_pattern = [0]*20
        for i in range(len(mal_perm)):
            pattern = re.compile(mal_perm[i], re.IGNORECASE)
            try:
                with open (str(files[j]).replace(".apk","")+".xml", 'rt') as in_file:        
                    for  linenum, line in enumerate(in_file): 
                        if pattern.search(line) != None:
                            bit_pattern[i]=1
            except FileNotFoundError:
                print("Log file not found.")
        dst=os.getcwd()+"/mal_xml/"+str(files[j]).replace(".apk","")+".xml"
        src=os.getcwd()+"/"+str(files[j]).replace(".apk","")+".xml"
        shutil.move(src,dst)
        ds.write((str(files[j].encode("utf-8")).replace(",","_")+","+(str(bit_pattern).replace("[","").replace("]","")+"\n")).replace("b'","").replace("'",""))
print("SUCCESSFULLY FECTHED DATASET")
ds.close()
os.chdir("..")
src=os.getcwd()+"/malware/dataset.csv"
dst=os.getcwd()
shutil.move(src,dst)
